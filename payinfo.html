<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Matt Art</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <!-- Vendor CSS Files -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="assets/css/vendor.css">
    <link rel="stylesheet" type="text/css" href="assets/css/common.css">
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Open+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

    <style>
      .progressbar {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 120px;
        gap: 24px;
      }

      .progressbar .step-container {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .progressbar .step-container .step-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 1px solid #dee2e6;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 8px;
        color: black;
      }

      .progressbar .step-container .step-circle.active {
        border: 1px solid #f7a422;
        background-color: #ffc43f;
        color: white;
      }

      .progressbar .step-container .step-title {
        color: black;
        font-size: 18px;
      }

      @media (max-width: 768px) {
        .responsive-table tr {
          display: block;
        }

        .responsive-table td {
          display: block;
          width: 100% !important;
        }
      }

      label::after {
        content: " *";
        color: rgba(var(--bs-danger-rgb));
      }

      .paytype {
        border: 1px solid #ddd;
        box-shadow: 2px 5px 5px -4px #ddd;
        text-align: center;
        cursor: pointer;
        padding: 20px 20px;
        margin: 10px 0;
        font-weight: bold;
      }

      .paytype.choosed {
        background-color: var(--bs-primary);
        color: white;
      }

    </style>

  </head>
  <body>
    
    <!-- Content -->
    <section class="py-5">
      <div class="container-fluid py-5" style="background-color: #f7f7f7;">
        
        <div class="progressbar d-none d-md-flex">

          <div class="step-container">
            <div class="step-circle active">âœ”</div>
            <div class="step-title">è³¼ç‰©æ¸…å–®</div>
          </div>

          <div style="border-bottom: 2px solid black; width: 100px;"></div>

          <div class="step-container">
            <div class="step-circle active">2</div>
            <div class="step-title">ä»˜æ¬¾è³‡è¨Š</div>
          </div>

          <div style="border-bottom: 2px solid black; width: 100px;"></div>

          <div class="step-container">
            <div class="step-circle">3</div>
            <div class="step-title">å®Œæˆè¨‚è³¼</div>
          </div>

        </div>

        <div class="payinfo-shop">
          <h5 class="border-bottom py-3">è³¼è²·å•†å“</h5>
        </div>
        
        <div class="bg-white p-3 mb-5 border">
          <table class="table align-middle text-center" id="payinfo-table">
            <thead>
              <th class="text-start" style="white-space: nowrap;">å•†å“åç¨±</th>
              <th width="30px">å–®åƒ¹</th>
              <th width="60px">æ•¸é‡</th>
              <th width="30px">å°è¨ˆ</th>
            </thead>
            <tbody>

            </tbody>
          </table>
        </div>

        <div class="row">
            
          <!-- è¨‚è³¼äººè³‡è¨Š -->
          <div class="col-md-6">
            <div class="bg-white p-4 border mb-3">
              <h5 class="mb-4 pb-2 border-bottom">è¨‚è³¼äººè³‡è¨Š</h5>
                
              <table class="responsive-table">
                <thead>
                  <tr>
                    <th width="100px"></th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr style="vertical-align: top;">
                    <td><label for="buyer-name" class="form-label fw-medium">å§“å</label></td>
                    <td>
                      <input type="text" class="form-control rounded-2" id="buyer-name" placeholder="è«‹è¼¸å…¥å§“å">
                      <div>â€»è¨‚è³¼äººå§“åç‚ºæ—¥å¾Œè¨‚å–®æŸ¥è©¢ä½¿ç”¨ï¼Œè«‹ç¢ºå¯¦å¡«å¯«ã€‚</div>
                    </td>
                  </tr>
                  
                  <tr style="vertical-align: top;">
                    <td><label for="buyer-email" class="form-label fw-medium">é›»å­ä¿¡ç®±</label></td>
                    <td>
                      <input type="email" class="form-control rounded-2" id="buyer-email" placeholder="example@email.com">
                      <div>â€»è«‹å¡«å¯«å¸¸ç”¨çš„ E-mail ä¿¡ç®±ï¼Œç¢ºä¿æ‚¨èƒ½æ”¶åˆ°è¨‚è³¼ç›¸é—œè¨Šæ¯ã€‚</div>
                    </td>
                  </tr>

                  <tr style="vertical-align: top;">
                    <td><label for="buyer-phone" class="form-label fw-medium">é›»è©±è™Ÿç¢¼</label></td>
                    <td>
                      <input type="tel" class="form-control rounded-2" id="buyer-phone" placeholder="0912-345-678">
                      <div>â€» é›»è©±è™Ÿç¢¼è«‹ä»¥é€£çºŒæ•¸å­—æ ¼å¼å¡«å¯«ã€‚</br>â€» æˆ‘å€‘å°‡ä»¥ç°¡è¨Šé€šçŸ¥æ‚¨äº¤æ˜“è¨Šæ¯ï¼Œç‚ºç¢ºä¿æ‚¨èƒ½æ”¶åˆ°è¨Šæ¯ï¼Œè«‹å„ªå…ˆå¡«å¯«è¡Œå‹•é›»è©±è™Ÿç¢¼ã€‚</div>
                    </td>
                  </tr>

                </tbody>
              </table>

            </div>

            <div class="bg-white p-4 border mb-3 payment-section">
              <h5 class="mb-4 pb-2 border-bottom">é¸æ“‡ä»˜æ¬¾æ–¹å¼</h5>

              <div class="row row-cols-4">
                <div class="col">
                  <div class="paytype" data-value="Line Pay">Line Pay</div>
                </div>
                <div class="col">
                  <div class="paytype" data-value="aaaa">æ–‡åŒ–å¹£</div>
                </div>
                <div class="col">
                  <div class="paytype" data-value="cash">ç¾é‡‘</div>
                </div>
              </div>

            </div>

            <div class="bg-white p-4 border mb-3 shipping-section">
              <h5 class="mb-4 pb-2 border-bottom">é¸æ“‡é‹é€æ–¹å¼</h5>

              <div class="row row-cols-4">
                <div class="col">
                  <div class="paytype" data-value="1">è¶…å•†å–è²¨</div>
                </div>
                <div class="col">
                  <div class="paytype" data-value="2">æ”¤ä½å–è²¨</div>
                </div>
                <div class="col">
                  <div class="paytype" data-value="3">é€çµ¦åˆ¥äºº</div>
                </div>
              </div>

            </div>

            <input type="hidden" id="selected-payment-method" value="">
            <input type="hidden" id="selected-shipping-method" value="">

          </div>

          <!-- æ”¶ä»¶äººè³‡è¨Š -->
          <div class="col-md-6 mb-3">
            <div class="bg-white p-4 border mb-3">
              <h5 class="mb-4 pb-2 border-bottom">æ”¶ä»¶äººè³‡è¨Š</h5>


              <table class="responsive-table">
                <thead>
                  <tr>
                    <th width="100px"></th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="align-middle">
                      <div class="d-flex align-items-center">
                        <input type="checkbox" class="form-check-input me-2" id="is-same-buyer">
                        <span>åŒè¨‚è³¼äºº</span>
                      </div>
                    </td>
                    <td></td>
                  </tr>

                  <tr>
                    <td style="white-space: nowrap; vertical-align: top;"><label for="recipient-name" class="form-label fw-medium me-4">æ”¶ä»¶äººå§“å</label></td>
                    <td>
                      <input type="text" class="form-control rounded-2" id="recipient-name" placeholder="è«‹è¼¸å…¥æ”¶ä»¶äººå§“å">
                      <div class="text-danger fw-bold">â€»æ”¶è²¨äººå§“åç‚ºç‰©æµé…é€ä½¿ç”¨ï¼Œè«‹ç¢ºå¯¦å¡«å¯«ã€‚</div>
                    </td>
                  </tr>
                  
                  <tr>
                    <td style="white-space: nowrap; vertical-align: top;"><label for="recipient-email" class="form-label fw-medium me-4">é›»å­ä¿¡ç®±</label></td>
                    <td>
                      <input type="email" class="form-control rounded-2" id="recipient-email" placeholder="example@email.com">
                      <div class="text-danger fw-bold">â€»è«‹å¡«å¯«å¸¸ç”¨çš„ E-mail ä¿¡ç®±ï¼Œç¢ºä¿æ‚¨èƒ½æ”¶åˆ°é…é€ç›¸é—œè¨Šæ¯ã€‚</div>
                    </td>
                  </tr>

                  <tr>
                    <td style="white-space: nowrap; vertical-align: top;"><label for="recipient-phone" class="form-label fw-medium me-4">é›»è©±è™Ÿç¢¼</label></td>
                    <td>
                      <input type="tel" class="form-control rounded-2" id="recipient-phone" placeholder="0912-345-678">
                      <div class="text-danger fw-bold">â€» é›»è©±è™Ÿç¢¼è«‹ä»¥é€£çºŒæ•¸å­—æ ¼å¼å¡«å¯«ã€‚</br>â€» æˆ‘å€‘å°‡ä»¥ç°¡è¨Šé€šçŸ¥æ‚¨äº¤æ˜“è¨Šæ¯ï¼Œç‚ºç¢ºä¿æ‚¨èƒ½æ”¶åˆ°è¨Šæ¯ï¼Œè«‹å„ªå…ˆå¡«å¯«è¡Œå‹•é›»è©±è™Ÿç¢¼ã€‚</div>
                    </td>
                  </tr>

                  <tr>
                    <td style="white-space: nowrap; vertical-align: top;"><label for="recipient-address" class="form-label fw-medium me-4">æ”¶è²¨åœ°å€</label></td>
                    <td>
                      <input type="text" class="form-control rounded-2" id="recipient-address" placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€">
                      <div class="text-danger fw-bold">
                        â€» å•†å“é…é€æ™‚é–“ç‚ºç™½å¤©ï¼Œè«‹å¡«å¯«ç™½å¤©å¯ä»¥ç°½æ”¶çš„ä¸­æ–‡åœ°å€ï¼Œä»¥åˆ©å®…é…äººå“¡è¾¨è­˜èˆ‡è¯ç¹«ã€‚
                        </br>â€» å› å•†å“é…é€æ–¹å¼æ¡ç”¨å®…é…åˆ°åºœï¼Œéœ€è¦å°ˆäººç°½æ”¶ï¼Œå¯„é€åœ°å€è«‹å‹¿å¡«å¯«éƒµæ”¿ä¿¡ç®±ã€‚
                        </br>â€» å–®ç­†äº¤æ˜“æ»¿ NT$ 2,000 å…ƒå…ç‰©æµè²»ã€‚
                      </div>
                    </td>
                  </tr>

                </tbody>
              </table>

            </div>

            <div class="bg-white p-4 border mb-3">
              <h5 class="mb-4 pb-2 border-bottom">å‚™è¨»ç•™è¨€</h5>

              <textarea class="form-control rounded-2" style="height: 100px; text-align: left; vertical-align: top; resize: vertical;" id="buyer-memo"></textarea>
            </div>

          </div>
            
        </div>

        <div class="order-footer">
          <div class="d-flex flex-column flex-md-row justify-content-between fw-bold">
            <a href="myorder.html" style="margin: 8px 0; padding: 8px 32px; border: solid 1px #ffc000; cursor: pointer; color: var(--bs-primary); text-align: center; text-decoration: none;">å›è³¼ç‰©è»Šé é¢</a>
            <a class="pay-btn" style="margin: 8px 0; padding: 8px 32px; border: solid 1px #ffc000; background-color: var(--bs-primary); cursor: pointer; color: white; text-align: center; text-decoration: none;">ç¢ºèªçµå¸³</a>
          </div>
        </div>

      </div>
    </section>

    <!-- Vendor JS Files -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/jquery-1.11.0.min.js"></script>
    <script src="assets/js/plugins.js"></script>
    <script type="module" src="assets/js/header-footer.js"></script>
    <script type="module">
      import {setCookie, loadCartFromCookie, renderCart, getCart, setCart} from './assets/js/modules/cart.js';
      import {createProduct, renderNewProducts, renderHotProducts, renderAllProducts, getProductList, renderBackendProduct, renderOrdertList, renderPayList, getPaymentAmt, createOrder, setPaymentAmt} from './assets/js/modules/product.js';

      (function($) {

        "use strict";

        function generateUniqueOrderNumber() {
          const now = new Date();
          const year = String(now.getFullYear()).slice(-2);
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          
          // çµ„åˆï¼šæ¯«ç§’ + éš¨æ©Ÿæ•¸
          const timestamp = now.getTime();  // æ¯«ç§’ç´šæ™‚é–“æˆ³
          const random = Math.floor(Math.random() * 1000);  // 0-999 éš¨æ©Ÿæ•¸
          
          // ç”Ÿæˆ 5 ä½å”¯ä¸€ç·¨è™Ÿ
          const uniqueId = String(timestamp % 100000 + random).padStart(5, '0');
          
          return `${year}${month}${day}${uniqueId}`;
        }

        // document ready
        $(document).ready(function() {
          let cart = getCart();

          renderPayList(cart);

          $('.payment-section .paytype').on('click', function() {
            $('.payment-section .paytype').removeClass('choosed');
        
            // æ·»åŠ  .choosed åˆ°é»æ“Šçš„å…ƒç´ 
            $(this).addClass('choosed');
            
            // å„²å­˜é¸æ“‡çš„å€¼
            const value = $(this).data('value');
            $('#selected-payment-method').val(value);
            console.log('âœ… ä»˜æ¬¾æ–¹å¼:', value);
          });

          $('.shipping-section .paytype').on('click', function() {
            // ç§»é™¤åŒå€åŸŸæ‰€æœ‰ .choosed é¡åˆ¥
            $('.shipping-section .paytype').removeClass('choosed');
            
            // æ·»åŠ  .choosed åˆ°é»æ“Šçš„å…ƒç´ 
            $(this).addClass('choosed');
            
            // å„²å­˜é¸æ“‡çš„å€¼
            const value = $(this).data('value');
            $('#selected-shipping-method').val(value);
            console.log('âœ… é‹é€æ–¹å¼:', value);
          });

          $('#is-same-buyer').on('change', function(e){
            const isChecked = $(this).prop('checked');

            const buyerName = $('#buyer-name').val();
            const buyerEmail = $('#buyer-email').val();
            const buyerPhone = $('#buyer-phone').val();

            const $recName = $('#recipient-name');
            const $recEmail = $('#recipient-email');
            const $recPhone = $('#recipient-phone');

            if (isChecked) {
              $recName.val(buyerName).prop('disabled', true);
              $recEmail.val(buyerEmail).prop('disabled', true);
              $recPhone.val(buyerPhone).prop('disabled', true);
            } else {
              $recName.prop('disabled', false);
              $recEmail.prop('disabled', false);
              $recPhone.prop('disabled', false);
            }
          });

          $('.pay-btn').click(async function() {

            const requiredIds = [
              'buyer-name', 'buyer-email', 'buyer-phone',
              'recipient-name', 'recipient-email', 'recipient-phone', 'recipient-address'
            ];

            let hasError = false;
    
            requiredIds.forEach(id => {
              const $input = $(`#${id}`);
              const value = $input.val();

              // æª¢æŸ¥æ˜¯å¦ç‚ºç©º
              if (value == null || String(value).trim() === '') {
                  $input.addClass('is-invalid'); // ğŸ”‘ è®“æ¡†è®Šç´…
                  hasError = true;
              } else {
                  $input.removeClass('is-invalid'); // æ¸…é™¤ç´…æ¡†
              }
            });


            if (hasError) {
              alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼');
              return false;
            }

            const selectedPayment = $('#selected-payment-method').val();
            const selectedShipping = $('#selected-shipping-method').val();
            console.log(selectedPayment);
            
            if (!selectedPayment) {
                alert('è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼');
                return;
            }
            
            if (!selectedShipping) {
                alert('è«‹é¸æ“‡é‹é€æ–¹å¼ï¼');
                return;
            }

            const nowtime = new Date().toLocaleString('zh-TW', {
                              year: 'numeric',
                              month: '2-digit',
                              day: '2-digit',
                              hour: '2-digit',
                              minute: '2-digit',
                              hour12: false
                            });

            const orderData = {
              order_number: generateUniqueOrderNumber(),
              order_date: nowtime,
              order_status: 'pending',
              buyer_name: $('#buyer-name').val(),
              buyer_email: $('#buyer-email').val(),
              buyer_phone: $('#buyer-phone').val(),
              recipient_name: $('#recipient-name').val(),
              recipient_email: $('#recipient-email').val(),
              recipient_phone: $('#recipient-phone').val(),
              recipient_address: $('#recipient-address').val(),
              payment_method: selectedPayment,
              payment_status: 'unpaid',
              total_amount: parseFloat(sessionStorage.getItem('orderTotal')) || 0,
              shipping_fee: 60,
              discount_amount: 0,
              notes: $('#buyer-memo').val(),
              created_at: nowtime,
              updated_at: nowtime
            }

            const orderItems = cart.map(item => ({
              order_id: "TEMP",  // å‰ç«¯éš¨ä¾¿å¡«ï¼Œå¾Œç«¯æœƒè¦†è“‹
              product_id: item.datacode,
              product_name: `${item.feature}æ¨£å¼${item.category_cn}`,
              unit_price: item.price,
              quantity: item.purchaseQty,
              subtotal: item.price * item.purchaseQty,
              created_at: nowtime
            }));

            const itemsList = cart.map(item => 
              `â€¢ ${item.feature}æ¨£å¼${item.category_cn} x ${item.purchaseQty} = $${item.price * item.purchaseQty}`
            ).join('\n');

            const orderMessage = [
                  `ğŸ‰ è¨‚å–®æˆç«‹é€šçŸ¥`,
                  ``,
                  `ğŸ“¦ è¨‚å–®ç·¨è™Ÿ: ${orderData.order_number}`,
                  `ğŸ“… è¨‚å–®æ—¥æœŸ: ${orderData.order_date}`,
                  `ğŸ’³ ä»˜æ¬¾æ–¹å¼: ${orderData.payment_method}`,
                  `ğŸ’° è¨‚å–®é‡‘é¡: $${orderData.total_amount}`,
                  ``,
                  `ğŸ“ æ”¶ä»¶è³‡æ–™`,
                  `${orderData.recipient_name}`,
                  `${orderData.recipient_phone}`,
                  `${orderData.recipient_address}`,
                  ``,
                  `ğŸ›ï¸ è³¼è²·å•†å“`,
                  itemsList,
                  ``,
                  `ğŸ’µ ç¸½è¨ˆ: $${orderData.total_amount + orderData.shipping_fee - orderData.discount_amount}`
              ].join('\n').trim();

            try {
              const result = await createOrder(orderData, orderItems, orderMessage);
              
              if (result.success) {
                  alert(`âœ… è¨‚å–®å»ºç«‹æˆåŠŸï¼\nè¨‚å–®ç·¨è™Ÿ: ${orderData.order_number}`);
                  
                  // æ¸…ç©ºè³¼ç‰©è»Šä¸¦è·³è½‰
                  //localStorage.removeItem('cart');
                  //window.location.href = 'order-success.html';
              }
                
            } catch (error) {
                console.error('å»ºç«‹è¨‚å–®å¤±æ•—:', error);
                alert('å»ºç«‹è¨‚å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }       
          });
        });
      })(jQuery);

    </script>
  </body>
</html>